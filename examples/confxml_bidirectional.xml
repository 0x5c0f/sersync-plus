<?xml version="1.0" encoding="UTF-8"?>
<head version="2.5">
    <!-- Sersync åŒå‘åŒæ­¥é…ç½®ç¤ºä¾‹ -->

    <!-- æœ¬åœ°ä¸»æœºé…ç½® -->
    <host hostip="localhost" port="8008"></host>

    <!-- è°ƒè¯•æ¨¡å¼ -->
    <debug start="true"/>

    <!-- æ–‡ä»¶ç³»ç»Ÿç±»å‹ -->
    <fileSystem xfs="false"/>

    <!-- åŒæ­¥é…ç½® -->
    <sersync>
        <!-- æœ¬åœ°ç›‘æ§è·¯å¾„ -->
        <localpath watch="/data/shared">
            <!-- åŒå‘åŒæ­¥è¿œç¨‹ç›®æ ‡ -->
            <remote ip="192.168.1.100" name="backup" 
                    mode="bidirectional" 
                    node_id="node-1"
                    conflict_strategy="keep_newer" 
                    sync_interval="60">
                
                <!-- å¯é€‰ï¼šè‡ªå®šä¹‰å…ƒä¿¡æ¯è·¯å¾„ï¼ˆé»˜è®¤ä¼šè‡ªåŠ¨ç”Ÿæˆå®‰å…¨è·¯å¾„ï¼‰ -->
                <!-- æ³¨æ„ï¼šå…ƒä¿¡æ¯ç›®å½•ä¸åº”æ”¾åœ¨watchç›®å½•å†…ï¼Œé¿å…åŒæ­¥å†²çª -->
                <metadata sync_state_dir="/var/sersync/metadata/shared"
                          conflict_backup_dir="/var/sersync/conflicts/shared"
                          lock_file="/var/sersync/locks/shared.lock"/>
            </remote>
            
            <!-- å¯ä»¥åŒæ—¶é…ç½®å•å‘åŒæ­¥çš„è¿œç¨‹ç›®æ ‡ -->
            <remote ip="192.168.1.200" name="backup2" mode="unidirectional"/>
        </localpath>

        <!-- Rsync é…ç½® -->
        <rsync>
            <commonParams params="-artuz"/>
            <auth start="true" users="rsync_user" passwordfile="/etc/rsync.password"/>
            <userDefinedPort start="false" port="873"/>
            <timeout start="true" time="100"/>
            <ssh start="true" user="root" port="22"/>
        </rsync>

        <!-- å¤±è´¥é‡è¯• -->
        <failLog path="/var/sersync/rsync_fail.sh" timeToExecute="60"/>

        <!-- å®šæ—¶å…¨é‡åŒæ­¥ -->
        <crontab start="true" schedule="600">
            <crontabfilter start="false">
                <exclude expression="(.*)\.log"/>
            </crontabfilter>
        </crontab>

        <!-- æ’ä»¶ç³»ç»Ÿï¼ˆé¢„ç•™ï¼‰ -->
        <plugin start="false" name="command"/>
    </sersync>

    <!-- æ–‡ä»¶è¿‡æ»¤ -->
    <filter start="true">
        <exclude expression="(.*)\.tmp"/>
        <exclude expression="(.*)\.swp"/>
        <exclude expression="(.*)\.log"/>
        <exclude expression="^\.git"/>
        <!-- è‡ªåŠ¨æ’é™¤å¯èƒ½çš„å…ƒä¿¡æ¯ç›®å½• -->
        <exclude expression="\.sersync"/>
    </filter>

    <!-- Inotify é…ç½® -->
    <inotify>
        <delete start="true"/>
        <closeWrite start="true"/>
        <moveFrom start="true"/>
        <moveTo start="true"/>
        <attrib start="false"/>
        <modify start="false"/>
        <createFolder start="true"/>
        <createFile start="true"/>
    </inotify>

    <!-- å®šæ—¶å…¨é‡åŒæ­¥ -->
    <crontab start="true" schedule="600">
        <crontabfilter start="false">
            <exclude expression="(.*)\.log"/>
        </crontabfilter>
    </crontab>

    <!-- å¤±è´¥é‡è¯• -->
    <failLog path="/var/sersync/rsync_fail.sh" timeToExecute="60"/>

    <!-- åŒå‘åŒæ­¥å…¨å±€é…ç½® -->
    <bidirectional enabled="true" 
                   default_conflict_strategy="keep_newer"
                   default_sync_interval="60"
                   metadata_base_dir="/var/sersync/bidirectional"
                   enable_conflict_backup="true"
                   max_conflict_backups="10"/>

    <!-- é€šçŸ¥ç³»ç»Ÿ -->
    <notification enabled="true" config="/etc/sersync/apprise.yml">
        <rules>
            <rule event="sync_failed" notify="immediate" tags="admin,alert"/>
            <rule event="sync_success" notify="batch" tags="info" batch_size="100" batch_interval="300"/>
            <rule event="bidirectional_conflict" notify="immediate" tags="admin,conflict"/>
            <rule event="bidirectional_sync" notify="batch" tags="info" batch_size="50" batch_interval="600"/>
        </rules>

        <templates>
            <template name="bidirectional_conflict">
                <title>âš ï¸ åŒå‘åŒæ­¥å†²çª - {file_path}</title>
                <body>æ–‡ä»¶: {file_path}
å†²çªç±»å‹: {conflict_type}
è§£å†³ç­–ç•¥: {resolution_strategy}
è¿œç¨‹èŠ‚ç‚¹: {remote}
æ—¶é—´: {timestamp}</body>
            </template>
            
            <template name="bidirectional_sync">
                <title>ğŸ”„ åŒå‘åŒæ­¥å®Œæˆ - {remote}</title>
                <body>è¿œç¨‹èŠ‚ç‚¹: {remote}
æ£€æµ‹åˆ°å˜åŒ–: {changes_detected}
è§£å†³å†²çª: {conflicts_resolved}
åŒæ­¥æ–‡ä»¶: {files_synced}
æ—¶é—´: {timestamp}</body>
            </template>
        </templates>
    </notification>

    <!-- Web ç®¡ç†ç•Œé¢ -->
    <web start="true" port="8000" host="0.0.0.0">
        <auth enabled="true" username="admin" password="admin123"/>
    </web>

    <!-- è°ƒè¯•æ¨¡å¼ -->
    <debug start="true"/>
</head>
